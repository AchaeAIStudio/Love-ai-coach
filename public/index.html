<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>AI 관계 코치</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 480px;
    margin: auto;
    background:#fafafa;
  }
  .screen { display: none; }
  .active { display: block; }
  button {
    width: 100%;
    padding: 14px;
    margin-top: 12px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
    cursor: pointer;
    background:#3a66ff;
    color:white;
  }
  .option-btn {
    border-radius: 22px;
    border:1px solid #ddd;
    padding: 10px;
    margin: 6px 0;
    background: white;
    cursor:pointer;
  }
  .selected { background:#3a66ff; color:white; border-color:#3a66ff; }

  .circle-wrap { display:flex; gap:10px; margin:20px 0; justify-content:center;}
  .circle { 
    width:45px; height:45px; border-radius:50%; 
    border:1px solid #aaa; display:flex; align-items:center; justify-content:center;
    font-size:13px; cursor:pointer; background:white;
  }
  .circle.selected { background:#3a66ff; color:white; }

  textarea { width:100%; height:120px; padding:10px; border-radius:8px; border:1px solid#ccc; }

  .loading { text-align:center; font-size:20px; padding:50px 0; }
  .result-card {
    background:white; padding:15px; border-radius:12px; margin-top:12px;
    border:1px solid #ddd;
  }
</style>
</head>

<body>

<!-- 전체 화면 컨테이너 -->
<div id="screen-start" class="screen active">
  <h2>AI 관계 코치</h2>
  <p>당신의 성향과 대화를 기반으로<br> 상대의 마음과 전략을 분석해드립니다.</p>

  <input id="userName" placeholder="이름 입력" style="width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;">
  <button onclick="startApp()">시작하기</button>
</div>

<!-- 1. 내 성향 질문 -->
<div id="screen-myq" class="screen">
  <h2 id="qTitle">질문 1/5</h2>
  <p id="qText">나는 걱정이 많은 편이다.</p>

  <div class="circle-wrap">
    <div class="circle" onclick="selectAnswer(1)">1</div>
    <div class="circle" onclick="selectAnswer(2)">2</div>
    <div class="circle" onclick="selectAnswer(3)">3</div>
    <div class="circle" onclick="selectAnswer(4)">4</div>
    <div class="circle" onclick="selectAnswer(5)">5</div>
  </div>

  <button onclick="nextQuestion()">다음</button>
</div>

<!-- 2. MBTI 선택 -->
<div id="screen-mbti" class="screen">
  <h2>당신의 MBTI를 선택해주세요</h2>

  <div id="mbtiList" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:20px;"></div>

  <button onclick="goPartnerScreen()">다음</button>
</div>

<!-- 3. 상대 성향 선택 -->
<div id="screen-partner" class="screen">
  <h2>상대방의 특징을 선택해주세요</h2>
  <p>최대 2개 선택</p>

  <div id="partnerList"></div>

  <button onclick="goChatScreen()">다음</button>
</div>

<!-- 4. 카톡 텍스트 분석 -->
<div id="screen-chat" class="screen">
  <h2>카톡 대화 분석</h2>
  <textarea id="chatText" placeholder="최근 카톡 대화를 붙여넣어주세요"></textarea>
  <button onclick="submitToAI()">AI 분석 시작</button>
</div>

<!-- 5. 로딩 -->
<div id="screen-loading" class="screen">
  <div class="loading">
    <p>AI 분석 중...</p>
    <p>잠시만 기다려주세요.</p>
  </div>
</div>

<!-- 6. 결과 화면 -->
<div id="screen-result" class="screen">
  <h2>AI 진단 결과</h2>

  <div class="result-card" id="result-intent">상대 의도 분석</div>
  <div class="result-card" id="result-strategy">대화 전략</div>
  <div class="result-card" id="result-message">추천 멘트</div>

  <button onclick="restart()">다시 분석하기</button>
</div>

<script>
/* ====== 글로벌 상태값 ====== */
let state = {
  userName: "",
  myAnswers: [],
  myMBTI: "",
  partnerFeel: [],
  chatText: "",
  situation: "썸",
  goal: "상대의 의도를 정확히 알고 싶다."
};

/* ====== 화면 전환 ====== */
function show(screenId){
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(screenId).classList.add("active");
}

function startApp(){
  state.userName = document.getElementById("userName").value || "사용자";
  show("screen-myq");
}

/* ====== 내 성향 질문 로직 ====== */
const questions = [
  "나는 걱정이 많은 편이다.",
  "나는 감정을 솔직하게 표현하는 편이다.",
  "나는 사람들과 있을 때 에너지를 얻는다.",
  "나는 계획적으로 행동하는 편이다.",
  "나는 갈등 상황을 피하려고 한다."
];
let qIndex = 0;
let lastAnswer = 0;

function selectAnswer(score){
  lastAnswer = score;
  document.querySelectorAll(".circle").forEach(c=>c.classList.remove("selected"));
  event.target.classList.add("selected");
}

function nextQuestion(){
  if(lastAnswer === 0) return alert("점수를 선택해주세요!");
  state.myAnswers.push(lastAnswer);
  lastAnswer = 0;

  qIndex++;
  if(qIndex < questions.length){
    document.getElementById("qTitle").innerText = `질문 ${qIndex+1}/5`;
    document.getElementById("qText").innerText = questions[qIndex];
    document.querySelectorAll(".circle").forEach(c=>c.classList.remove("selected"));
  } else {
    loadMBTI();
    show("screen-mbti");
  }
}

/* ====== MBTI 선택 ====== */
function loadMBTI(){
  const mbtis = ["INTJ","INTP","INFJ","INFP","ENTJ","ENTP","ENFJ","ENFP",
                 "ISTJ","ISTP","ISFJ","ISFP","ESTJ","ESTP","ESFJ","ESFP"];
  const list = document.getElementById("mbtiList");
  list.innerHTML = "";

  mbtis.forEach(m=>{
    const btn = document.createElement("div");
    btn.className = "option-btn";
    btn.innerText = m;
    btn.onclick = ()=> {
      document.querySelectorAll("#mbtiList .option-btn").forEach(b=>b.classList.remove("selected"));
      btn.classList.add("selected");
      state.myMBTI = m;
    };
    list.appendChild(btn);
  });
}

function goPartnerScreen(){
  if(!state.myMBTI) return alert("MBTI를 선택해주세요!");
  loadPartnerFeel();
  show("screen-partner");
}

/* ====== 상대 특징 선택 ====== */
function loadPartnerFeel(){
  const feels = ["감정적","논리적","직관적","즉흥적","계획적","말수가 적다","답장 느리다","차갑다","따뜻하다"];
  const list = document.getElementById("partnerList");
  list.innerHTML = "";

  feels.forEach(f=>{
    const btn = document.createElement("div");
    btn.className = "option-btn";
    btn.innerText = f;
    btn.onclick = ()=>{
      if(btn.classList.contains("selected")){
        btn.classList.remove("selected");
        state.partnerFeel = state.partnerFeel.filter(x=>x!==f);
      } else {
        if(state.partnerFeel.length >= 2) return alert("최대 2개까지 선택 가능합니다!");
        btn.classList.add("selected");
        state.partnerFeel.push(f);
      }
    };
    list.appendChild(btn);
  });
}

function goChatScreen(){
  if(state.partnerFeel.length === 0) return alert("특징을 최소 1개 선택해주세요!");
  show("screen-chat");
}

/* ====== AI 분석 요청 ====== */
async function submitToAI(){
  state.chatText = document.getElementById("chatText").value.trim();
  if(!state.chatText) return alert("카톡 대화를 입력해주세요!");

  show("screen-loading");

  const res = await fetch("/api/coach", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(state)
  });

  const data = await res.json();

  show("screen-result");

  if(data.ok){
    const msg = data.aiMessage.split("\n");
    document.getElementById("result-intent").innerText = msg[0] || "의도 분석 없음";
    document.getElementById("result-strategy").innerText = msg[1] || "전략 없음";
    document.getElementById("result-message").innerText = msg.slice(2).join("\n") || "추천 멘트 없음";
  } else {
    document.getElementById("result-intent").innerText = "오류 발생";
    document.getElementById("result-strategy").innerText = data.error;
    document.getElementById("result-message").innerText = "";
  }
}

function restart(){
  location.reload();
}

</script>

</body>
</html>
